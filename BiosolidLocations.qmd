---
title: "Biosolids Location"
author: "Jane Ho"
format: html
---

```{r, echo = FALSE}
library(leaflet)
library(janitor)
library(tidyr)
library(dplyr)
library(readxl)
library(purrr)
library(ggplot2)
library(viridis)
options(scipen=10000)
```

# Overview

Ontario approved the Canada Council of Ministers of the Environment's Approach and the supporting Guidance Document for the Beneficial Use of Municipal Biosolids, Municipal Sludge and Treated Septage (2012) which present best management practices, and encourage the beneficial use and sound management of municipal biosolids across Canada.

The Ministry of Environment, Conservation and Parks' (MECP) 2025 mandate for OCWA is for it to deliver on municipal infrastructure resiliency, including supporting resource recovery from waste, and working with OCWA's clients to optimize their wastewater facilities. OCWA's 2025 to 2027 Business Plan, as part of Strategic Direction 3 (Supporting Climate Action and Environmental Stewardship), commits the Agency to working with interested clients to identify and implement new waste diversion and resource recovery opportunities in their communities and where feasible, to close the loop and sustainably manage biosolids storage and disposal.

Ontario Clean Water Agency's (OCWA) Residuals Resources Management Program aims to centralize residuals information systematically , align practices to policies and client priorities, and share market, technology and emerging issues reviews for operations reference.

*Climate, public health risks Managing risks requires consideration of future climate, infrastructure scenarios (planning for tomorrow); integrating adaptation measure in planning means protecting operational resilience, community health, and economic sustainability.*

*Wastewater residuals present potential hazards if not properly managed, but also entails an opportunity to better monitor its quality & application, which will facilitate OCWA to communicate transparently on an evidence-basis to client & users.*

# Structure

The Residuals Resources Management Program is structured in two streams:

1.  Core Program will create an internal inventory and benchmark from available OCWA operations & financial records. Regular reviews of policy, OCWA practices, and emerging issues will be conducted. Holistic consideration of these primarily technical information will translate into actionable insights, to be shared with operations management & procurement.

2.  Initiatives Development examines opportunities to implement improved residuals management. This includes technology and funding opportunities review, practice optimization, assessment of client and state-of-infrastructure priorities to identify candidate facilities.

Both streams, especially (1) will be made transparent to operations and management staff with the aim of establishing a collaborative & evidence-based program. Information pipelines will be established for regular update & reproducibility, with production documentation and "live" summaries made available on Sharepoint.

# Detailed Approach

## Core Program

The core program will canvas the current state of residuals handling in OCWA facilities. The main strands of information to be organized are listed below.

1.  OCWA facilities metadata, e.g. location, permit, hub, client, population, holding capacity, treatment process, geographical context
2.  Inventory of residuals quantity and quality
3.  Market landscape including reference regional and quality-based ranges. Both external costs (hauling & disposal), climate impacts, and nutrient/NASM valuation\
4.  Lagoons, e.g. status, inspections, clean-out undertakings
5.  Policy, regulations, and emerging issues review

Useable outcomes from the above inventory canvassing work:

1.  Data record & quality gaps will be made evident. Condensed and visualized gaps will be shared to be transparent about the bases (and lacks thereof) for the subsequent outcomes. Regional & logistical (e.g. by VoR) geographical clustering will be plotted & made visible within OCWA for planning reference.

    *Articulate the opportunities lost due to data gaps (rather than it being just a problem) - a social contract of give and get;*

2.  Priorities and risks (capacity or quality hotspots) & opportunities (landfill/cost abnormalities) will be identified tracked in a registry

3.  Benchmarks (e.g. production rates & quality, costs) and action triggers will be established based on a blend of hard limits and quantified distribution from the inventory exercise.

    *build economic case; recognize uncertainty*

4.  With consideration of policies, regulation and historical operations handling, establish a reference "Plinko" board/flowchart of actions. There is potential duplication/cross-feed with:

    1.  Lagoon Listing SD2 (Angela compliance hotspots)
    2.  Lagoon SOP (consult Raj & James)
    3.  Ops checklist for residuals handling e.g. pre NASM/haulage checks

5.  Reference information for operations management

    1.  Regulatory Changes Monitoring ("delegate" this to external)
    2.  Scientific/political/social risk factor scans ("delegate" this to external)
    3.  VOR & contract/procurement templates for haulage/NASM/disposal

6.  An information gathering "pipeline" protocol that will be published on Sharepoint, such that this exercise is reproducible and which may serve as reference for other IPOTS data gathering efforts.

    *Hardwiring so it works continuously & transparent (trusted)*

------------------------------------------------------------------------

How's\
4.1 1. Compliance (Julie's colleague)\
2. Recycle from 2019 Program\
3. Other (TSSA inspection)\
4.2\
1. NEBRA communiques\
2. university/conference information gathering

## Initiatives & Technology Development

Input: items 2 & 3 from Core

1.  Grants & academic opp. tracking (Bhavik noted to check with Jisna; PPDG)
    1.  Review monthly, sharing
2.  Shortlist & ready-made background on candidate plants (NB we have more sites than technologies so screen former rather than latter)
    1.  (inherited listed Peel, Norfolk, Bradford, Barrie, Waterloo // Stratford)
3.  Client priority flagging - connect with hub BD managers
4.  Roster of avail. tech pilots
    1.  ITAD
5.  Biogas / Co-gen process set-up & ops (Clarkson)
6.  Nutrient Trading / GHG accounting

## Base Requirement

1.  Collation repository & sharing location;
2.  Information sources acquisition & review
3.  

# Data inventory

record & quality gaps Condensed and visualized gaps will be shared to be transparent about the bases (and lacks thereof) for the subsequent outcomes. Regional & logistical (e.g. by VoR) geographical clustering will be plotted & made public for planning reference

## Information Source Scan

+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| Ref  | Name                                  | Source/Owner                                | Description                                                                                                | Quality                                                                                     | Expected Use                                                                                                                              | Repeatable origin                   | Ready for intake | Cleaning programmed |
|      |                                       |                                             |                                                                                                            |                                                                                             |                                                                                                                                           |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             |                                                                                                                                           |                                     | (df name)        |                     |
+======+=======================================+=============================================+============================================================================================================+=============================================================================================+===========================================================================================================================================+=====================================+==================+=====================+
| 1    | Biosolids Program Overview            | Shelly/Seii (copy from ReadMe)              | Receiving aggregation of information                                                                       | Indirect compilation with personal ops verification, but dated                              | Treatment type                                                                                                                            | No                                  |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             |                                                                                                                                           |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             | historical -\> home format                                                                                                                |                                     |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| 2    | Finance Db                            | GP (cleaned for audit)                      | 2023,2024; haulers                                                                                         | 1 year back                                                                                 | Summative amount, YOY change (but missing quantity context - use as search start for invoices)                                            | Yes                                 |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             |                                                                                                                                           |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            | cleaned for audit use                                                                       |                                                                                                                                           |                                     |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| 3    | WISKI metadata                        | Compliance but Aziz (PCTs resp. for update) | should contain process unit (y/n), end site, ECA, facility number, location                                | Lacking update (only \~17 plants listed as updated 2024-2025) - unsure of current accuracy  | (check with Holly then Angela on PCT expectations - is this still meant to hold the info or deemed inadequate)                            | Yes - ad hoc                        |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             |                                                                                                                                           |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            | Almost all missing coordinates, a great number missing physical location (to enable lookup) | no batch updates possible                                                                                                                 |                                     |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| 4    | WISKI BSD Report (reporting services) | Compliance/Holly/DIY                        | Need to run reports of individual plants (click ea. individual plant-station-param combo), cannot overarch | WISKI quality - plant dependent                                                             | annual quantities & confirmation of destination overlap 4                                                                                 | Yes - ad hoc                        |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| 5    | WISKI                                 | BSLQ, WAS, EFF data dump                    | not able to generate by reporting services - crash. Need Aziz to query                                     | WISKI quality - plant dependent                                                             | varying quantity and quality of biosolids, very rough ratio of production compared to effluent & WAS.                                     | Yes - ad hoc                        |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             |                                                                                                                                           |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             | Effluent reporting to determine if we are operating a facility (N.B. Peel, Elgin-Huron and Kitchener do not use wiski)                    |                                     |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| 5    | WISKI                                 | Compliance/Holly/DIY                        | Effluent                                                                                                   |                                                                                             | confidence if we are operating a facility                                                                                                 | Yes - ad hoc                        |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| 5    | Facility Annual Reports               | Compliance                                  |                                                                                                            |                                                                                             | overlap 3                                                                                                                                 | No                                  |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             |                                                                                                                                           |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             | just for gleaning location, general info by reading                                                                                       |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             |                                                                                                                                           |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             | file location? - Holly indicated not all plants are required so WISKI entry may be better                                                 |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             |                                                                                                                                           |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             | Fiscal & calendar years -- reports -- Joanne asking regional sharepoints to be populated by facility list (e.g. Midwest Eastern has done) |                                     |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| 6    | Lagoon list SD 2                      | Compliance/Angela                           |                                                                                                            | personal consultations around hubs                                                          |                                                                                                                                           | No...                               |                  |                     |
|      |                                       |                                             |                                                                                                            |                                                                                             |                                                                                                                                           |                                     |                  |                     |
|      |                                       |                                             |                                                                                                            | how is this maintained?                                                                     |                                                                                                                                           | Looks like manual job by compliance |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| 7    | Maximo exports                        | BAMS - Paul Grech (?)                       |                                                                                                            |                                                                                             | are PPDG efforts logged                                                                                                                   |                                     |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| 8    | Procurement records                   | Procurement                                 |                                                                                                            |                                                                                             |                                                                                                                                           |                                     |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+
| 9    | Operations contracts                  | BD (Ralph) CRM                              | Contracts (generally mixed W/WW) are organized by clients and not sure which facilities belong             |                                                                                             | duration only (if updated)                                                                                                                | Yes ad hoc                          |                  |                     |
+------+---------------------------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+------------------+---------------------+

Data Notes

-   org number is unique as it is assigned by finance during contracts and will be common WISKI, SCADA and LRDC

    -   versus facility number (N.B. the ones that don't have a number might fall under a bigger client & facility)

-   Some regions don't use wiski -- Huron Elgin, Kitchener, Peel

    Joanne Tam, Holly, Aziz

    Is biosolids data always in "Blsq" station in WISKI

    2.Biosolids report -- is there quantity besides quality?  Or that is in annual plant reports

    Can we go "up" a level -- e.g. all the biosolids quality & quantity from all the plants instead of generating for every plant.  NO

## Geography

maps

# Risks & opportunities registry

(capacity or quality hotspots) (landfill/cost abnormalities)

# Benchmarking

(e.g. production rates & quality, costs) and action triggers will be established based on a blend of hard limits and quantified distribution from the inventory exercise.

## Costs

```{r}
#grab all excel names as a character vector
#2023 & 2024 are all fake-filled with Biosolids for now

fnames <- fs::dir_ls('data/4-Costing/Payables', regexp = '.XLSX') #gp export was weird - caps 
fnames <- fnames[!grepl("~", fnames)] #remove any temp files with ~
dt_costs <- bind_rows(lapply(fnames, read_excel, col_names = TRUE, trim_ws=TRUE))%>% 
  filter(CostCategoryName == 'BIOSOLIDS\\SLUDGE') #%>% won't work b/c 2023 & 2024 has no category columns downloaded #TBD

#TEMPORARY REMOVE ONCE COLUMNS ARE CONSISTENT TBD
dt_costs <- dt_costs %>% 
  unite(VendorID, c(VendorID,`Vendor ID`), na.rm = TRUE, remove = TRUE) %>%
  unite(DescriptionSupplierClientName, c(DescriptionSupplierClientName,`Vendor Name`), na.rm = TRUE, remove = TRUE) %>% 
  unite(GlPostingDate, c(GlPostingDate,'GL Posting Date'), na.rm = TRUE, remove = TRUE) %>% 
  unite(Amount, c(Amount, 'Total CAD'), na.rm=TRUE, remove=TRUE)

#vendors just start with 2021
dt_vendors<-read_excel("data/4-Costing/Payables/2021 BIOSLD_MWSW Regions costs.XLSX", col_names = TRUE) %>% 
  select("VendorID", "DescriptionSupplierClientName","PAprojname", "GlPostingDate", "Amount") %>% 
  unique() %>% #in case there are dup charges - don't care
  drop_na("VendorID") # NAs are all acct actions like accruals & transfers

# number of unique vendors providing biosolids services (82)
length(unique(dt_vendors$DescriptionSupplierClientName))
# number of unique "projects" receiving biosolids services
length(unique(dt_vendors$PAprojname))
#unique(dt_vendors$PAprojname)

```

```{r}
#all vendors are too much to visualize: break it up
#set up levels by total amount
dt_vendors_summ <- dt_vendors %>%
  group_by(DescriptionSupplierClientName,VendorID) %>%
  summarize(invoicesSum = sum(Amount),
            invoicesCount = n()) %>% 
  ungroup()

#set order
dt_vendors_summ %>% 
  ggplot(aes(x=DescriptionSupplierClientName, y=invoicesSum)) +
    geom_bar(stat="identity")+
  #  scale_x_discrete(limits=)
  coord_flip()
  
```

```{r}
#singleton providers #28 singles
dt_vendors_summ %>% 
  dplyr::filter(invoicesCount ==1) %>% 
  ggplot(aes(x=DescriptionSupplierClientName, y = invoicesSum)) +
  geom_bar(stat="identity")+
  ylab("Sum of invoices in year (single invoicers)")+
  coord_flip()
# 
# dt_vendors %>%
#   group_by(DescriptionSupplierClientName) %>%
#   dplyr::filter(n() == 1) %>% #28 singles
#   ungroup() %>% 
#   arrange(desc(Amount)) %>% 
#   ggplot(aes(x=DescriptionSupplierClientName)) +
#     geom_bar(stat="count")+
# #    scale_x_discrete(limits=) #rearrange
#   coord_flip()

#  arrange(desc(n)) %>%
```

```{r}
#multiple instances
# just an indication there're lots of invoices....
dt_vendors %>%
  group_by(DescriptionSupplierClientName) %>%
  dplyr::filter(n() > 1) %>% 
  ungroup() %>% 
  ggplot(aes(x=DescriptionSupplierClientName)) +
    geom_bar(stat="count")+
    ylab("Number of Invoices in Year")+
    coord_flip()

dt_vendors_summ %>% 
  dplyr::filter(invoicesCount >1) %>% 
  ggplot(aes(x=DescriptionSupplierClientName, y = invoicesSum)) +
  geom_bar(stat="identity")+
  ylab("Sum of invoices in year, multiple invoicers")+
  coord_flip()

#cross plot rates, charged hub (waffle)
```
```{r}
#find proportion and maybe focus on the biggest 20?
library(treemap)
plot_proportionInvoice<-treemap(dt_vendors_summ, 
        index = "DescriptionSupplierClientName", vSize = "invoicesSum", type = "index",  title = " ", fontsize.labels = c(22))

#cannot ggplotly this treemap
```
```{r}
library(treemapify)
p_haulVendors<-
  ggplot(dt_vendors_summ, aes(area = invoicesSum, fill = invoicesSum, label = DescriptionSupplierClientName)) +
  geom_treemap() +
  geom_treemap_text(colour = "white", place = "centre", size = 10) +
  scale_fill_viridis_c(guide = guide_legend(keywidth = unit(1, "cm")))+ #enlarge legend
  theme(legend.position = "bottom") +
  labs(fill = "Sum of invoices related to biosolids/sludge, 2021")
p_haulVendors

ggsave(file="export/p_haulVendors.svg", plot=p_haulVendors, width=16, height=9)
```


```{r}
#can do something intermediate above to see which PA ~ vendor
#too many lines to see - reduce to top 5
list_vendorsTop<- dt_vendors_summ %>% arrange(desc(invoicesSum)) %>% slice(1:5) %>% select("VendorID","DescriptionSupplierClientName")

dt_vendors_flow<-select(dt_vendors, -c("GlPostingDate")) %>% 
  inner_join(list_vendorsTop)#clean up before pivot

library(ggsankeyfier)  
es_long <-
  pivot_stages_longer(
    ## the data.frame we wish to pivot:
    data = dt_vendors_flow,
    ## the columns that represent the stages:
    stages_from = c("DescriptionSupplierClientName", "PAprojname"),
    ## the column that represents the size of the flows:
    values_from = "Amount"
  )

pos <- position_sankey(v_space = "auto", order = "descending")

ggplot(es_long,
       aes(x = stage, y = Amount, group = node,
           connector = connector, edge_id = edge_id)) +
  geom_sankeyedge(aes(fill = node), position = pos) +
  geom_sankeynode(position = pos) +
  scale_fill_viridis_d() +
  geom_text(aes(label = node), stat = "sankeynode", position = pos, cex = 2) 


# dt_vendors$flowSize<- #dummy
# dt_vendors<-select(dt_vendors, -c("GlPostingDate", "Amount")) #clean up before pivot
# 
# es_long <-
#   pivot_stages_longer(
#     ## the data.frame we wish to pivot:
#     data = dt_vendors,
#     ## the columns that represent the stages:
#     stages_from = c("DescriptionSupplierClientName", "PAprojname"),
#     ## the column that represents the size of the flows:
#     values_from = "flowSize"
#   )
# 
# ggplot(es_long,
#        aes(x = stage, y = flowSize, group = node,
#            connector = connector, edge_id = edge_id)) +
#   geom_sankeyedge(v_space = "auto") +
#   geom_sankeynode(v_space = "auto")

#just the 2021 since 2023 and 2024 are missing PA projname

```

```{r}
#ladder steps year to year value
dt_vendors_yoy<-select(dt_costs, c("GlPostingDate", "VendorID", "Amount")) %>% 
  inner_join(list_vendorsTop)#join by DescriptionSupplierClientName / vendor name
dt_vendors_yoy$GlPostingDate<-as.Date(dt_vendors_yoy$GlPostingDate)
dt_vendors_yoy$year<-lubridate::year(dt_vendors_yoy$GlPostingDate)
dt_vendors_yoy$Amount<-as.numeric(dt_vendors_yoy$Amount)

dt_vendors_yoy <- dt_vendors_yoy %>%
  group_by(DescriptionSupplierClientName,year) %>%
  summarize(annualSum = sum(Amount)) %>% 
  ungroup()

# Basic line graph with points
ggplot(data=dt_vendors_yoy, aes(x=year, y=annualSum, group=DescriptionSupplierClientName, colour = DescriptionSupplierClientName)) +
  geom_line() +
  geom_point()
#  geom_text(check_overlap = TRUE)

```


```{r}
#histogram of annual flows (waffle hub?)
#histogram of costs
```

## Procurement
```{r}
fnames <- fs::dir_ls('data/4-Costing/Procurement', regexp = 'Biosolids Schedule Master')  
fnames <- fnames[!grepl("~", fnames)] #remove any temp files with ~
dt_procurement <- bind_rows(lapply(fnames, read_excel, col_names = TRUE, trim_ws=TRUE, 
                                   skip=5))

#clean up totals and comments at end
dt_procurement <-dt_procurement %>% slice(1:max(which(!is.na(Hub))))

#break up the mixed column of hubs and facility
#first line in 2nd column after a blank row is a hub (a hub can also have no sub plants)
list_hub<-which(is.na(dt_procurement$Hub)) # these are the blank rows preceding a hub
list_hub<- list_hub+1

dt_hub<- dt_procurement %>% slice(list_hub) %>% drop_na(Hub) #an extra blank row for a missing facility in KW...
dt_hub<-dt_hub %>% mutate(Facility="hub")

dt_procurement<-dt_procurement %>% mutate(Facility=Hub)
dt_procurement$Facility[list_hub]<-NA #remove hubs
dt_procurement$Hub[-list_hub]<-NA #remove facilities

dt_procurement <- dt_procurement %>% 
  dplyr::filter(!(is.na(Hub) & is.na(Facility)))%>% 
  fill(Hub) %>% 
  drop_na(Facility)

#Essex and non-hub(?) Midhurst Valley don't have specific facility rates, need to reinsert back in below  
dt_procurement<-rbind(dt_procurement, dt_hub %>% subset(!is.na(`Current Vendor`)))

#dt_procurement %>% mutate_at(ends_with(c("Cost", "Price"), as.numeric)) # fails - ends with must be used with selecting; also there is inconsistent column header in price TBD janitor clean all names before

dt_procurement_cost<-dt_procurement %>% 
  pivot_longer(cols=ends_with("Cost"), names_to = "year", values_to = "cost", 
               values_transform = list(cost=as.numeric), #there are stray chara typos in cost columns - just coerce to NA
               names_pattern = "(.*) Cost") #remove suffix from pivoted years
```


```{r}
#let's look at costs (prices still to pivot long)
p_costRate<-ggplot(dt_procurement_cost, aes(x = year, y = cost, color = Hub))+
  geom_point()+
  scale_y_continuous(limits=c(0, 80)) #TEMPORARY get rid of lump sums

library(plotly)
ggplotly(p_costRate)

```

```{r}
# Plot
p_costRate<-
  dt_procurement_cost %>%
    filter(cost<100) %>% #TEMPORARY remove lump sum
    ggplot( aes(x=year, y=cost, fill=Hub)) +
      geom_boxplot() +
      scale_fill_viridis(discrete = TRUE, alpha=0.6) +
      geom_jitter(color="black", size=0.4, alpha=0.9) #+
      #theme_ipsum() +
      #theme(legend.position="none", plot.title = element_text(size=11)) %>% 

p_costRate
#ggplotly(p_costRate) #hub-bars overlap, would need add'l fix
```

```{r}
# Plot
p_costRate<-
  dt_procurement_cost %>%
    filter(cost<100) %>% #TEMPORARY remove lump sum
    ggplot( aes(x=year, y=cost, fill=year)) +
      geom_boxplot() +
      scale_fill_viridis(discrete = TRUE, alpha=0.6) +
      geom_jitter(color="black", size=0.4, alpha=0.9) #+
      #theme_ipsum() +
      #theme(legend.position="none", plot.title = element_text(size=11)) %>% 

ggplotly(p_costRate)

library(htmlwidgets)

# Save ggplotly as widget in file test.html
saveWidget(ggplotly(p_costRate), file = "p_costRate.html")
```





```{r, eval = FALSE}
#handle dates
library(lubridate)
dt_costs$GlPostingDate <-as.Date(dt_costs$GlPostingDate) #2021
dt_costs$`Receipt Date`<- as.Date(dt_costs$`Receipt Date`) #2023, 2024
dt_costs <- dt_costs %>% mutate(`Receipt Date` = ifelse(`Receipt Date` %in% "", GlPostingDate, `Receipt Date`))


dt_costs$year<-year(dt_costs$`Receipt Date`)
dt_costs$month<-month(dt_costs$`Receipt Date`)

ggplot(dt_costs, aes(DescriptionSupplierClientName,Amount))+
  geom_point()+
  facet_grid(cols = vars(year))
```



Shelly/Seii 2018 excel overview -\> filter for facilities with landfill end-site

all but one without phy location

```{r, eval=FALSE}
#1st file - coords for a few, lots facilities
dt_loc_coord <- read_excel('data/2-Facilities/Wiski7_Sites_Metadata_XY_Coordinates (1).xlsx', col_names = TRUE, trim_ws=TRUE) %>% drop_na("JH-Mod") 

#2nd source file: has some phys address, no coords, less facilities, has process unit
dt_loc_address <- read_excel('data/2-Facilities/All_WTF_WWTF_Metadata.xlsx', col_names = TRUE, trim_ws=TRUE) 
#addresses need to be made consistent for lookup

library(stringr)
dt_loc_address$`Physical Location`<-
  dt_loc_address$`Physical Location` %>% 
  str_replace_all(' Canada', '') %>% 
  str_replace_all(' ON', ' Ontario, Canada') %>% 

dt_loc_address<- dt_loc_address %>%
  mutate(
    `Physical Location` = if_else(
      !str_detect(`Physical Location`, "Ontario"), 
      str_c(`Physical Location`, ", Ontario, Canada", sep = " "), 
      `Physical Location`
    )
  )

dt_loc_address<- dt_loc_address %>%
  mutate(
    `Physical Location` = if_else(
      !str_detect(`Physical Location`, "Canada"), 
      str_c(`Physical Location`, ", Canada", sep = " "), 
      `Physical Location`
    )
)  

#3rd source file: manual kml (ECA addresses followed by manual visual check on google maps)

library(leaflet)    # interactive maps
library(sf)

loc_kml <- st_read("data/2-Facilities/BIOSOLIDS.kml")

plot(loc_kml[1])

```

Start python
```{r, eval=FALSE}
Sys.setenv(RETICULATE_PYTHON = "C:/Users/hoja/AppData/Local/anaconda3")
```

reticulate::repl_python() 

```{python, eval=FALSE}
import pandas as pd
from geopy.geocoders import Nominatim #had to pip install this first

#Using Nominatim with the default user_agent is strongly discouraged, as it violates Nominatim’s Usage Policy https://operations.osmfoundation.org/policies/nominatim/ and may possibly cause 403 and 429 HTTP errors. Please make sure to specify a custom user_agent with Nominatim(user_agent="my-application")
geolocator = Nominatim(user_agent="myApp")

dt_loc_py = r.dt_loc #import df from R to Py https://nrennie.rbind.io/blog/combining-r-and-python-with-reticulate-and-quarto/

#claims to have no attribute latitude
# dt_loc_py[['location_lat', 'location_long']] = dt_loc_py['Address'].apply(geolocator.geocode).apply(lambda x: pd.Series([x.latitude, x.longitude], index=['location_lat', 'location_long']))

# dt_loc_py[['location']] = dt_loc_py['Address'].apply(geolocator.geocode) # this doesn't work unless all addresses can be found - number will mismatch

#this works
# geolocator.geocode(dt_loc_py['Address'][1])
# geolocator.geocode(dt_loc_py['Address'][1]).latitude
```

```{python, eval=FALSE}
lat = [] 
longi = [] 
location = [] 

for places in dt_loc_py['Address']:
  location.append(geolocator.geocode(places, timeout=100)) #, timeout=100
  lat.append(location[len(location)-1].latitude)
  longi.append(location[len(location)-1].longitude) 
  
#match back to df 
dt_loc_py['lat'] = lat 
dt_loc_py['longi'] = longi 
```

#Map
```{r, eval=FALSE}
dt_loc_py<-py$dt_loc_py#[-ncol(py$dt_loc_py)]#drop last column coz it's a mess
dt_loc_py<-dt_loc_py %>% rename(lng = longi)
dt_loc_py$Category<-as.factor(dt_loc_py$Category) # Create a palette that maps factor levels to colors 
pal <- colorFactor(c("pink", "turquoise", "blue", "green","purple", "orange", "gray", "black"), domain = c("Food", "Sight","Sight, Food", "Shop, sight","Shop", "Activity", "Base", "NA"))
```

```{r, eval=FALSE}
map_geo<-dt_loc_py %>% 
  leaflet::leaflet() %>%
  leaflet::addProviderTiles(providers$OpenStreetMap.HOT)%>% #Thunderforest.Transport is better but not loadiing...api key needed?
  addCircleMarkers(data = subset(dt_loc_py, !is.na(Saturday)),
                   lng = ~lng, lat = ~lat, 
                   group = "Saturday",
                   popup = ~Place,
                   radius = 9,
                   color = ~pal(Category)) %>% 
  addCircleMarkers(data = subset(dt_loc_py, !is.na(Sunday)),
                   lng = ~lng, lat = ~lat, 
                   group = "Sunday",
                   popup = ~Place,
                   radius = 9,
                   color = ~pal(Category)) %>% 
  addCircleMarkers(data = subset(dt_loc_py, !is.na(Monday)),
                   lng = ~lng, lat = ~lat, 
                   group = "Monday",
                   popup = ~Place,
                   radius = 9,
                   color = ~pal(Category)) %>% 
  addCircleMarkers(data = subset(dt_loc_py, !is.na(Tuesday)),
                   lng = ~lng, lat = ~lat, 
                   group = "Tuesday",
                   popup = ~Place,
                   radius = 9,
                   color = ~pal(Category)) %>% 
  addCircleMarkers(data = subset(dt_loc_py, !is.na(Wednesday)),
                   lng = ~lng, lat = ~lat, 
                   group = "Wednesday",
                   popup = ~Place,
                   radius = 9,
                   color = ~pal(Category)) %>% 
  addCircleMarkers(data = subset(dt_loc_py, !is.na(Thursday)),
                   lng = ~lng, lat = ~lat, 
                   group = "Thursday",
                   popup = ~Place,
                   radius = 9,
                   color = ~pal(Category)) %>% 
  addCircleMarkers(data = subset(dt_loc_py, !is.na(Friday)),
                   lng = ~lng, lat = ~lat, 
                   group = "Friday",
                   popup = ~Place,
                   radius = 9,
                   color = ~pal(Category)) %>% 
  addLegend(pal = pal, values = ~Category, position = "bottomleft") %>%
  addLayersControl(overlayGroups = c("Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"),
                   options = layersControlOptions(collapsed = FALSE))
```



Location of plants with landfilled biosolids
**Shelly - try to find ones taking leachate**
```{r, eval = FALSE}
pal <- colorFactor(topo.colors(8), dt_loc$Hub)

map_geo<-dt_loc %>% 
  leaflet::leaflet() %>%
  leaflet::addProviderTiles(providers$Stadia.AlidadeSmooth)%>% #Thunderforest.Transport is better but not loadiing...api key needed?
  addCircleMarkers(data = dt_loc,
                   lng = ~Global_WGS84_Longiude, lat = ~Global_WGS84_Latitude,
                   label = ~as.character(Site_name),
                   labelOptions = labelOptions(noHide = T,textOnly = T), #direction = 'top'),
                   color = ~pal(Hub)
                   ) %>% 
  addLegend(pal = pal, values = ~Hub, position = "bottomleft") #%>%
  # addLayersControl(overlayGroups = c("EndSite1", "EndSite2"),
  #                  options = layersControlOptions(collapsed = FALSE))

map_geo
```


# Recommendations flowchart

of actions With consideration of policies, regulation and historical operations handling, establish a reference "Plinko" board/

==================


Notes from operators:
Preston goes to Galt, which is a central receiver for the area 2025.05.26